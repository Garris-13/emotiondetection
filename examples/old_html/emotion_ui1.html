<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡¨æƒ…è¯†åˆ«ä¸å¥åº·å»ºè®®ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            padding: 30px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eaeaea;
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .header h1 i {
            color: #3498db;
        }
        
        .header p {
            color: #7f8c8d;
            font-size: 1.1rem;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        .connection-status {
            margin: 15px auto;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            max-width: 400px;
        }
        
        .status-connected {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .status-disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
            animation: pulse 2s infinite;
        }
        
        .status-checking {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeaa7;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        .content-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .upload-section {
            flex: 1;
            min-width: 300px;
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .results-section {
            flex: 2;
            min-width: 300px;
        }
        
        .upload-area {
            border: 3px dashed #3498db;
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        
        .upload-area:hover {
            background: #e8f4fc;
            border-color: #2980b9;
            transform: translateY(-2px);
        }
        
        .upload-area i {
            font-size: 60px;
            color: #3498db;
            margin-bottom: 15px;
        }
        
        .upload-area h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .upload-area p {
            color: #7f8c8d;
            margin-bottom: 20px;
        }
        
        .upload-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .upload-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        
        .upload-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .file-info {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            border-left: 4px solid #3498db;
            display: none;
        }
        
        .preview-container {
            margin-top: 25px;
            text-align: center;
        }
        
        .preview-container img {
            max-width: 100%;
            max-height: 250px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .user-context {
            margin-top: 25px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border: 1px solid #eaeaea;
        }
        
        .user-context h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .context-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .context-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .context-item label {
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        .context-item select, .context-item input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .results-tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .tab-btn {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: #7f8c8d;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .tab-btn.active {
            background: #3498db;
            color: white;
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .emotion-chart-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
        }
        
        .emotion-summary {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
        }
        
        .main-emotion {
            text-align: center;
            flex: 1;
        }
        
        .emotion-icon {
            font-size: 50px;
            margin-bottom: 10px;
        }
        
        .emotion-name {
            font-size: 1.8rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .emotion-confidence {
            font-size: 1.2rem;
            color: #7f8c8d;
        }
        
        .emotion-bar {
            flex: 2;
            padding: 0 30px;
        }
        
        .probability-item {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .emotion-label {
            width: 100px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .probability-bar-container {
            flex: 1;
            height: 25px;
            background: #ecf0f1;
            border-radius: 12.5px;
            overflow: hidden;
            margin: 0 15px;
        }
        
        .probability-bar {
            height: 100%;
            border-radius: 12.5px;
            transition: width 1s ease;
        }
        
        .probability-value {
            width: 60px;
            text-align: right;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .advice-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .advice-category {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 4px solid #3498db;
        }
        
        .advice-category h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .advice-category h4 i {
            color: #3498db;
        }
        
        .advice-list {
            list-style: none;
        }
        
        .advice-list li {
            padding: 10px 0 10px 30px;
            position: relative;
            border-bottom: 1px solid #eee;
        }
        
        .advice-list li:last-child {
            border-bottom: none;
        }
        
        .advice-list li:before {
            content: "âœ“";
            position: absolute;
            left: 0;
            color: #2ecc71;
            font-weight: bold;
        }
        
        .risk-indicator {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #fff3cd;
            border-radius: 10px;
            margin-top: 20px;
            border: 1px solid #ffeaa7;
        }
        
        .risk-level {
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .risk-low { background: #d4edda; color: #155724; }
        .risk-medium { background: #fff3cd; color: #856404; }
        .risk-high { background: #f8d7da; color: #721c24; }
        
        .emergency-alert {
            background: #f8d7da;
            border: 2px solid #f5c6cb;
            color: #721c24;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            animation: pulse 2s infinite;
        }
        
        .server-info {
            background: #e8f4fc;
            border: 1px solid #3498db;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            display: none;
        }
        
        .server-info.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        .server-info h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        
        .info-item {
            background: white;
            padding: 10px;
            border-radius: 5px;
        }
        
        .info-label {
            font-weight: 600;
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        .info-value {
            color: #2c3e50;
            word-break: break-all;
        }
        
        .connection-troubleshoot {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }
        
        .connection-troubleshoot.active {
            display: block;
        }
        
        .status-bar {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 50px;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            border-top: 1px solid #eee;
            margin-top: 30px;
        }
        
        @media (max-width: 768px) {
            .content-wrapper {
                flex-direction: column;
            }
            
            .emotion-summary {
                flex-direction: column;
                gap: 20px;
            }
            
            .emotion-bar {
                padding: 0;
                width: 100%;
            }
            
            .context-grid {
                grid-template-columns: 1fr;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-smile"></i> è¡¨æƒ…è¯†åˆ«ä¸å¥åº·å»ºè®®ç³»ç»Ÿ</h1>
            <p>ä¸Šä¼ é¢éƒ¨å›¾åƒï¼Œç³»ç»Ÿå°†è¯†åˆ«æ‚¨çš„æƒ…ç»ªå¹¶æä¾›ä¸ªæ€§åŒ–çš„å¥åº·å»ºè®®å’Œæƒ…ç»ªç®¡ç†ç­–ç•¥</p>
            
            <!-- è¿æ¥çŠ¶æ€æ˜¾ç¤º -->
            <div class="connection-status status-checking" id="connectionStatus">
                <i class="fas fa-sync fa-spin"></i>
                <span>æ­£åœ¨æ£€æŸ¥APIæœåŠ¡å™¨è¿æ¥...</span>
            </div>
        </div>
        
        <!-- æœåŠ¡å™¨ä¿¡æ¯é¢æ¿ -->
        <div class="server-info" id="serverInfo">
            <h4><i class="fas fa-server"></i> APIæœåŠ¡å™¨ä¿¡æ¯</h4>
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">æœåŠ¡å™¨åœ°å€</div>
                    <div class="info-value" id="serverUrl">http://localhost:5000</div>
                </div>
                <div class="info-item">
                    <div class="info-label">è¿æ¥çŠ¶æ€</div>
                    <div class="info-value" id="serverStatus">æ£€æŸ¥ä¸­...</div>
                </div>
                <div class="info-item">
                    <div class="info-label">è¿è¡Œè®¾å¤‡</div>
                    <div class="info-value" id="serverDevice">æœªçŸ¥</div>
                </div>
                <div class="info-item">
                    <div class="info-label">æ¨¡å‹çŠ¶æ€</div>
                    <div class="info-value" id="serverModel">æœªçŸ¥</div>
                </div>
            </div>
            
            <!-- è¿æ¥æ•…éšœæ’æŸ¥ -->
            <div class="connection-troubleshoot" id="connectionTroubleshoot">
                <h5><i class="fas fa-tools"></i> è¿æ¥é—®é¢˜æ’æŸ¥</h5>
                <p>å¦‚æœæ— æ³•è¿æ¥åˆ°APIæœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ï¼š</p>
                <ol>
                    <li>ç¡®ä¿APIæœåŠ¡å™¨å·²å¯åŠ¨ï¼ˆè¿è¡Œ <code>start_api.bat</code>ï¼‰</li>
                    <li>æ£€æŸ¥ç«¯å£5000æ˜¯å¦è¢«å ç”¨</li>
                    <li>å°è¯•åˆ·æ–°é¡µé¢é‡æ–°è¿æ¥</li>
                    <li>æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯</li>
                </ol>
                <button class="upload-btn" onclick="checkConnection()" style="margin-top: 10px; padding: 8px 16px;">
                    <i class="fas fa-redo"></i> é‡æ–°æµ‹è¯•è¿æ¥
                </button>
            </div>
        </div>
        
        <div class="content-wrapper">
            <!-- å·¦ä¾§ï¼šä¸Šä¼ åŒºåŸŸ -->
            <div class="upload-section">
                <div class="upload-area" id="uploadArea">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h3>ä¸Šä¼ é¢éƒ¨å›¾åƒ</h3>
                    <p>æ”¯æŒ JPGã€PNG æ ¼å¼ï¼Œæ–‡ä»¶å¤§å°ä¸è¶…è¿‡ 5MB</p>
                    <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-folder-open"></i> é€‰æ‹©å›¾åƒæ–‡ä»¶
                    </button>
                </div>
                
                <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFileSelect(event)">
                
                <div class="file-info" id="fileInfo">
                    <strong>å·²é€‰æ‹©æ–‡ä»¶:</strong> <span id="fileName"></span><br>
                    <strong>æ–‡ä»¶å¤§å°:</strong> <span id="fileSize"></span><br>
                    <strong>æ–‡ä»¶ç±»å‹:</strong> <span id="fileType"></span>
                </div>
                
                <div class="preview-container" id="previewContainer">
                    <img id="imagePreview" alt="å›¾åƒé¢„è§ˆ">
                </div>
                
                <!-- ç”¨æˆ·ä¸Šä¸‹æ–‡ä¿¡æ¯ -->
                <div class="user-context">
                    <h4><i class="fas fa-user-circle"></i> ä¸ªäººä¿¡æ¯ï¼ˆå¯é€‰ï¼‰</h4>
                    <div class="context-grid">
                        <div class="context-item">
                            <label>å¹´é¾„ç»„:</label>
                            <select id="ageGroup">
                                <option value="child">å„¿ç«¥ (0-12å²)</option>
                                <option value="teen">é’å°‘å¹´ (13-19å²)</option>
                                <option value="adult" selected>æˆäºº (20-59å²)</option>
                                <option value="elder">è€å¹´äºº (60å²ä»¥ä¸Š)</option>
                            </select>
                        </div>
                        <div class="context-item">
                            <label>æ˜¯å¦æœ‰æ”¯æŒç³»ç»Ÿ:</label>
                            <select id="hasSupport">
                                <option value="true" selected>æ˜¯</option>
                                <option value="false">å¦</option>
                            </select>
                        </div>
                        <div class="context-item">
                            <label>å‹åŠ›æ°´å¹³:</label>
                            <select id="stressLevel">
                                <option value="low">ä½</option>
                                <option value="medium" selected>ä¸­</option>
                                <option value="high">é«˜</option>
                            </select>
                        </div>
                        <div class="context-item">
                            <label>æ˜¯å¦é¦–æ¬¡ä½¿ç”¨:</label>
                            <select id="isFirstTime">
                                <option value="true">æ˜¯</option>
                                <option value="false" selected>å¦</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <button class="upload-btn" onclick="analyzeEmotion()" style="width: 100%; margin-top: 20px;" id="analyzeBtn">
                    <i class="fas fa-brain"></i> å¼€å§‹æƒ…ç»ªåˆ†æä¸å»ºè®®
                </button>
            </div>
            
            <!-- å³ä¾§ï¼šç»“æœåŒºåŸŸ -->
            <div class="results-section">
                <div class="results-tabs">
                    <button class="tab-btn active" onclick="switchTab('emotionTab')">
                        <i class="fas fa-chart-bar"></i> æƒ…ç»ªåˆ†æ
                    </button>
                    <button class="tab-btn" onclick="switchTab('adviceTab')">
                        <i class="fas fa-heart"></i> å¥åº·å»ºè®®
                    </button>
                    <button class="tab-btn" onclick="switchTab('detailsTab')">
                        <i class="fas fa-info-circle"></i> è¯¦ç»†æŠ¥å‘Š
                    </button>
                </div>
                
                <!-- æƒ…ç»ªåˆ†ææ ‡ç­¾é¡µ -->
                <div id="emotionTab" class="tab-content active">
                    <div class="emotion-chart-container">
                        <div class="emotion-summary">
                            <div class="main-emotion">
                                <div class="emotion-icon" id="mainEmotionIcon">ğŸ˜</div>
                                <div class="emotion-name" id="mainEmotionName">ç­‰å¾…åˆ†æ</div>
                                <div class="emotion-confidence" id="mainEmotionConfidence">ç½®ä¿¡åº¦: --%</div>
                            </div>
                            
                            <div class="emotion-bar">
                                <div id="probabilityBars">
                                    <p style="text-align: center; color: #7f8c8d;">ä¸Šä¼ å›¾åƒå¹¶ç‚¹å‡»åˆ†ææŒ‰é’®æŸ¥çœ‹ç»“æœ</p>
                                </div>
                            </div>
                        </div>
                        
                        <canvas id="emotionChart"></canvas>
                    </div>
                    
                    <div class="risk-indicator">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div>
                            <strong>é£é™©è¯„ä¼°:</strong> 
                            <span id="riskLevel" class="risk-level">æœªè¯„ä¼°</span>
                        </div>
                        <div id="riskDescription">è¯·å…ˆè¿›è¡Œåˆ†æ</div>
                    </div>
                </div>
                
                <!-- å¥åº·å»ºè®®æ ‡ç­¾é¡µ -->
                <div id="adviceTab" class="tab-content">
                    <div class="advice-section">
                        <h3 style="color: #2c3e50; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-hands-helping"></i> ä¸ªæ€§åŒ–å¥åº·å»ºè®®
                        </h3>
                        
                        <div class="advice-category">
                            <h4><i class="fas fa-bolt"></i> ç«‹å³è¡ŒåŠ¨å»ºè®®</h4>
                            <ul class="advice-list" id="immediateAdvice">
                                <li>è¯·å…ˆä¸Šä¼ å›¾åƒå¹¶è¿›è¡Œåˆ†æ</li>
                            </ul>
                        </div>
                        
                        <div class="advice-category">
                            <h4><i class="fas fa-calendar-day"></i> æ—¥å¸¸è´´å£«</h4>
                            <ul class="advice-list" id="dailyTips">
                                <li>è¯·å…ˆä¸Šä¼ å›¾åƒå¹¶è¿›è¡Œåˆ†æ</li>
                            </ul>
                        </div>
                        
                        <div class="advice-category">
                            <h4><i class="fas fa-seedling"></i> é•¿æœŸå»ºè®®</h4>
                            <ul class="advice-list" id="longTermSuggestions">
                                <li>è¯·å…ˆä¸Šä¼ å›¾åƒå¹¶è¿›è¡Œåˆ†æ</li>
                            </ul>
                        </div>
                        
                        <div id="emergencyAlert" class="emergency-alert" style="display: none;">
                            <i class="fas fa-exclamation-circle fa-2x"></i>
                            <div>
                                <strong>ç´§æ€¥æç¤º</strong>
                                <p id="emergencyText"></p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- è¯¦ç»†æŠ¥å‘Šæ ‡ç­¾é¡µ -->
                <div id="detailsTab" class="tab-content">
                    <div class="advice-section">
                        <h3 style="color: #2c3e50; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-file-medical-alt"></i> è¯¦ç»†æƒ…ç»ªåˆ†ææŠ¥å‘Š
                        </h3>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                            <h4>æƒ…ç»ªæ¨¡å¼åˆ†æ</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 15px;">
                                <div style="background: white; padding: 15px; border-radius: 8px;">
                                    <strong>æƒ…ç»ªå¤æ‚åº¦:</strong> <span id="complexityValue">--</span>
                                </div>
                                <div style="background: white; padding: 15px; border-radius: 8px;">
                                    <strong>æƒ…ç»ªå¼ºåº¦:</strong> <span id="intensityValue">--</span>
                                </div>
                                <div style="background: white; padding: 15px; border-radius: 8px;">
                                    <strong>æ˜¯å¦æ··åˆæƒ…ç»ª:</strong> <span id="mixedEmotions">--</span>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px;">
                            <h4>æ¬¡è¦æƒ…ç»ªè¯†åˆ«</h4>
                            <div id="secondaryEmotions" style="margin-top: 15px;">
                                <p style="color: #7f8c8d; text-align: center;">æš‚æ— æ¬¡è¦æƒ…ç»ªæ•°æ®</p>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px; padding: 20px; background: #e8f4fc; border-radius: 12px;">
                            <h4><i class="fas fa-lightbulb"></i> ä¸“å®¶å»ºè®®</h4>
                            <p id="expertAdvice" style="margin-top: 10px; line-height: 1.6;">
                                å®Œæ•´çš„ä¸“å®¶å»ºè®®å°†åœ¨æƒ…ç»ªåˆ†æåæ˜¾ç¤º
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>è¡¨æƒ…è¯†åˆ«ä¸å¥åº·å»ºè®®ç³»ç»Ÿ v2.0 | åŸºäºæ·±åº¦å­¦ä¹ çš„æƒ…æ„Ÿè¯†åˆ« | æä¾›å¿ƒç†å¥åº·æ”¯æŒ</p>
            <p>æ³¨æ„ï¼šæœ¬ç³»ç»Ÿä»…ä¾›å­¦ä¹ å’Œå‚è€ƒï¼Œå¦‚æœ‰ä¸¥é‡æƒ…ç»ªé—®é¢˜è¯·åŠæ—¶å¯»æ±‚ä¸“ä¸šå¿ƒç†å¸®åŠ©</p>
            <p style="margin-top: 10px; font-size: 0.9rem;">
                æœåŠ¡å™¨çŠ¶æ€: <span id="footerStatus">æ£€æŸ¥ä¸­...</span> | 
                æœ€åæ›´æ–°: <span id="lastUpdate">--</span>
            </p>
        </div>
    </div>
    
    <!-- çŠ¶æ€æç¤ºæ  -->
    <div id="statusBar" class="status-bar"></div>
    
    <script>
        // å…¨å±€å˜é‡
        let emotionChart = null;
        let currentImageData = null;
        let isConnected = false;
        const API_BASE_URL = 'http://localhost:7860';
        
        // æƒ…ç»ªå›¾æ ‡æ˜ å°„
        const emotionIcons = {
            'anger': 'ğŸ˜ ',
            'disgust': 'ğŸ¤¢',
            'fear': 'ğŸ˜¨',
            'happy': 'ğŸ˜Š',
            'sad': 'ğŸ˜¢',
            'surprised': 'ğŸ˜²'
        };
        
        // æƒ…ç»ªé¢œè‰²æ˜ å°„
        const emotionColors = {
            'anger': '#e74c3c',
            'disgust': '#27ae60',
            'fear': '#8e44ad',
            'happy': '#f39c12',
            'sad': '#3498db',
            'surprised': '#1abc9c'
        };
        
        // æƒ…ç»ªä¸­æ–‡åç§°æ˜ å°„
        const emotionChinese = {
            'anger': 'æ„¤æ€’',
            'disgust': 'åŒæ¶',
            'fear': 'ææƒ§',
            'happy': 'å¿«ä¹',
            'sad': 'æ‚²ä¼¤',
            'surprised': 'æƒŠè®¶'
        };
        
        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            // éšè—é¢„è§ˆå®¹å™¨
            document.getElementById('previewContainer').style.display = 'none';
            document.getElementById('fileInfo').style.display = 'none';
            
            // æ£€æŸ¥APIè¿æ¥
            checkConnection();
            
            // è®¾ç½®è‡ªåŠ¨è¿æ¥æ£€æŸ¥ï¼ˆæ¯30ç§’ä¸€æ¬¡ï¼‰
            setInterval(checkConnection, 30000);
            
            // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
            document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
        });
        
        // æ£€æŸ¥APIè¿æ¥
        async function checkConnection() {
            const statusDiv = document.getElementById('connectionStatus');
            const serverInfo = document.getElementById('serverInfo');
            const troubleshootDiv = document.getElementById('connectionTroubleshoot');
            const analyzeBtn = document.getElementById('analyzeBtn');
            const footerStatus = document.getElementById('footerStatus');
            
            // æ˜¾ç¤ºæ£€æŸ¥çŠ¶æ€
            statusDiv.className = 'connection-status status-checking';
            statusDiv.innerHTML = '<i class="fas fa-sync fa-spin"></i><span>æ­£åœ¨æ£€æŸ¥APIæœåŠ¡å™¨è¿æ¥...</span>';
            footerStatus.textContent = 'æ£€æŸ¥è¿æ¥ä¸­...';
            footerStatus.style.color = '#856404';
            
            try {
                // å°è¯•è¿æ¥API
                const response = await fetch(`${API_BASE_URL}/health`, {
                    method: 'GET',
                    timeout: 5000 // 5ç§’è¶…æ—¶
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // æ›´æ–°è¿æ¥çŠ¶æ€
                    isConnected = true;
                    statusDiv.className = 'connection-status status-connected';
                    statusDiv.innerHTML = `<i class="fas fa-check-circle"></i><span>âœ… å·²è¿æ¥åˆ°APIæœåŠ¡å™¨</span>`;
                    
                    // æ›´æ–°æœåŠ¡å™¨ä¿¡æ¯
                    document.getElementById('serverUrl').textContent = API_BASE_URL;
                    document.getElementById('serverStatus').textContent = 'å·²è¿æ¥';
                    document.getElementById('serverStatus').style.color = '#155724';
                    document.getElementById('serverDevice').textContent = data.device || 'CPU';
                    document.getElementById('serverModel').textContent = data.model_loaded ? 'å·²åŠ è½½' : 'æœªåŠ è½½';
                    
                    // æ˜¾ç¤ºæœåŠ¡å™¨ä¿¡æ¯
                    serverInfo.classList.add('active');
                    troubleshootDiv.classList.remove('active');
                    
                    // å¯ç”¨åˆ†ææŒ‰é’®
                    analyzeBtn.disabled = false;
                    analyzeBtn.title = 'ç‚¹å‡»å¼€å§‹åˆ†æ';
                    
                    // æ›´æ–°é¡µè„šçŠ¶æ€
                    footerStatus.textContent = 'å·²è¿æ¥';
                    footerStatus.style.color = '#155724';
                    
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    showStatus('å·²æˆåŠŸè¿æ¥åˆ°APIæœåŠ¡å™¨', 'success');
                    
                    console.log('APIæœåŠ¡å™¨ä¿¡æ¯:', data);
                    
                } else {
                    throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                }
                
            } catch (error) {
                // è¿æ¥å¤±è´¥
                isConnected = false;
                statusDiv.className = 'connection-status status-disconnected';
                statusDiv.innerHTML = `<i class="fas fa-times-circle"></i><span>âŒ æ— æ³•è¿æ¥åˆ°APIæœåŠ¡å™¨</span>`;
                
                // æ›´æ–°æœåŠ¡å™¨ä¿¡æ¯
                document.getElementById('serverStatus').textContent = 'è¿æ¥å¤±è´¥';
                document.getElementById('serverStatus').style.color = '#721c24';
                document.getElementById('serverDevice').textContent = 'æœªçŸ¥';
                document.getElementById('serverModel').textContent = 'æœªçŸ¥';
                
                // æ˜¾ç¤ºæœåŠ¡å™¨ä¿¡æ¯å’Œæ•…éšœæ’æŸ¥
                serverInfo.classList.add('active');
                troubleshootDiv.classList.add('active');
                
                // ç¦ç”¨åˆ†ææŒ‰é’®
                analyzeBtn.disabled = true;
                analyzeBtn.title = 'è¯·å…ˆè¿æ¥APIæœåŠ¡å™¨';
                
                // æ›´æ–°é¡µè„šçŠ¶æ€
                footerStatus.textContent = 'è¿æ¥å¤±è´¥';
                footerStatus.style.color = '#721c24';
                
                // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                showStatus(`è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                
                console.error('APIè¿æ¥é”™è¯¯:', error);
            }
        }
        
        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.type.startsWith('image/')) {
                showStatus('è¯·é€‰æ‹©å›¾åƒæ–‡ä»¶ (JPG, PNGç­‰)', 'error');
                return;
            }
            
            // æ£€æŸ¥æ–‡ä»¶å¤§å° (é™åˆ¶5MB)
            if (file.size > 5 * 1024 * 1024) {
                showStatus('æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº5MBçš„å›¾åƒ', 'error');
                return;
            }
            
            // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            document.getElementById('fileType').textContent = file.type;
            document.getElementById('fileInfo').style.display = 'block';
            
            // é¢„è§ˆå›¾åƒ
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewImg = document.getElementById('imagePreview');
                previewImg.src = e.target.result;
                document.getElementById('previewContainer').style.display = 'block';
                currentImageData = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabId) {
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾é¡µçš„activeç±»
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // æ¿€æ´»å½“å‰æ ‡ç­¾é¡µ
            event.target.classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }
        
        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type = 'success') {
            const statusBar = document.getElementById('statusBar');
            statusBar.textContent = message;
            statusBar.className = `status-bar status-${type}`;
            statusBar.style.display = 'block';
            
            setTimeout(() => {
                statusBar.style.display = 'none';
            }, 3000);
        }
        
        // åˆ†ææƒ…ç»ª
        async function analyzeEmotion() {
            // æ£€æŸ¥è¿æ¥çŠ¶æ€
            if (!isConnected) {
                showStatus('è¯·å…ˆç¡®ä¿APIæœåŠ¡å™¨å·²è¿æ¥', 'error');
                checkConnection();
                return;
            }
            
            if (!currentImageData) {
                showStatus('è¯·å…ˆé€‰æ‹©ä¸€å¼ å›¾åƒ', 'error');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const analyzeBtn = document.getElementById('analyzeBtn');
            const originalText = analyzeBtn.innerHTML;
            analyzeBtn.innerHTML = '<div class="loading"></div> åˆ†æä¸­...';
            analyzeBtn.disabled = true;
            
            // è·å–ç”¨æˆ·ä¸Šä¸‹æ–‡
            const userContext = {
                age_group: document.getElementById('ageGroup').value,
                has_support_system: document.getElementById('hasSupport').value === 'true',
                stress_level: document.getElementById('stressLevel').value,
                is_first_time: document.getElementById('isFirstTime').value === 'true'
            };
            
            try {
                // å°†base64æ•°æ®è½¬æ¢ä¸ºblob
                const base64Data = currentImageData.split(',')[1];
                const blob = b64toBlob(base64Data, 'image/jpeg');
                
                // åˆ›å»ºFormData
                const formData = new FormData();
                formData.append('image', blob, 'uploaded_image.jpg');
                formData.append('user_context', JSON.stringify(userContext));
                
                // æ˜¾ç¤ºè¿æ¥çŠ¶æ€
                showStatus('æ­£åœ¨åˆ†æå›¾åƒï¼Œè¯·ç¨å€™...', 'success');
                
                // å‘é€è¯·æ±‚
                const response = await fetch(`${API_BASE_URL}/predict_with_advice`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    // æ›´æ–°ç•Œé¢æ˜¾ç¤ºç»“æœ
                    updateEmotionDisplay(result.prediction);
                    updateAdviceDisplay(result.health_advice_report);
                    createEmotionChart(result.prediction.probabilities);
                    showStatus('æƒ…ç»ªåˆ†æå®Œæˆï¼', 'success');
                    
                    // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
                    document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
                } else {
                    throw new Error(result.error || 'åˆ†æå¤±è´¥');
                }
                
            } catch (error) {
                console.error('åˆ†æé”™è¯¯:', error);
                showStatus(`åˆ†æå¤±è´¥: ${error.message}`, 'error');
                
                // æ£€æŸ¥è¿æ¥æ˜¯å¦ä¸­æ–­
                if (error.message.includes('fetch') || error.message.includes('network')) {
                    isConnected = false;
                    checkConnection();
                }
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                analyzeBtn.innerHTML = originalText;
                analyzeBtn.disabled = false;
            }
        }
        
        // Base64è½¬Blob
        function b64toBlob(b64Data, contentType = '', sliceSize = 512) {
            const byteCharacters = atob(b64Data);
            const byteArrays = [];
            
            for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
                const slice = byteCharacters.slice(offset, offset + sliceSize);
                const byteNumbers = new Array(slice.length);
                
                for (let i = 0; i < slice.length; i++) {
                    byteNumbers[i] = slice.charCodeAt(i);
                }
                
                const byteArray = new Uint8Array(byteNumbers);
                byteArrays.push(byteArray);
            }
            
            return new Blob(byteArrays, { type: contentType });
        }
        
        // æ›´æ–°æƒ…ç»ªæ˜¾ç¤º
        function updateEmotionDisplay(prediction) {
            const { emotion, confidence, probabilities } = prediction;
            
            // æ›´æ–°ä¸»è¦æƒ…ç»ª
            document.getElementById('mainEmotionIcon').textContent = emotionIcons[emotion] || 'ğŸ˜';
            document.getElementById('mainEmotionName').textContent = emotionChinese[emotion] || emotion;
            document.getElementById('mainEmotionConfidence').textContent = `ç½®ä¿¡åº¦: ${(confidence * 100).toFixed(1)}%`;
            
            // æ›´æ–°æ¦‚ç‡æ¡
            const probabilityBars = document.getElementById('probabilityBars');
            probabilityBars.innerHTML = '';
            
            Object.entries(probabilities).forEach(([emo, prob]) => {
                const percentage = (prob * 100).toFixed(1);
                const barWidth = (prob * 100).toFixed(1);
                
                const barHtml = `
                    <div class="probability-item">
                        <div class="emotion-label">${emotionIcons[emo]} ${emotionChinese[emo] || emo}</div>
                        <div class="probability-bar-container">
                            <div class="probability-bar" 
                                 style="width: ${barWidth}%; background-color: ${emotionColors[emo] || '#3498db'}">
                            </div>
                        </div>
                        <div class="probability-value">${percentage}%</div>
                    </div>
                `;
                
                probabilityBars.innerHTML += barHtml;
            });
        }
        
        // æ›´æ–°å»ºè®®æ˜¾ç¤º
        function updateAdviceDisplay(adviceReport) {
            const { emotion_analysis, health_advice, risk_assessment, emergency_info } = adviceReport;
            
            // æ›´æ–°é£é™©è¯„ä¼°
            const riskLevel = document.getElementById('riskLevel');
            const riskDescription = document.getElementById('riskDescription');
            
            riskLevel.textContent = risk_assessment.risk_level;
            riskLevel.className = `risk-level risk-${risk_assessment.risk_level}`;
            riskDescription.textContent = risk_assessment.needs_attention ? 
                'éœ€è¦å…³æ³¨ï¼Œå»ºè®®é‡‡å–è¡ŒåŠ¨' : 'æƒ…å†µæ­£å¸¸ï¼Œå»ºè®®ä¿æŒ';
            
            // æ›´æ–°å»ºè®®åˆ—è¡¨
            updateAdviceList('immediateAdvice', health_advice.immediate_actions);
            updateAdviceList('dailyTips', health_advice.daily_tips);
            updateAdviceList('longTermSuggestions', health_advice.long_term_suggestions);
            
            // æ›´æ–°é¢å¤–å»ºè®®
            if (health_advice.additional_suggestions && health_advice.additional_suggestions.length > 0) {
                updateAdviceList('longTermSuggestions', health_advice.additional_suggestions, true);
            }
            
            // æ›´æ–°ç´§æ€¥æç¤º
            const emergencyAlert = document.getElementById('emergencyAlert');
            if (emergency_info && emergency_info.is_emergency) {
                document.getElementById('emergencyText').textContent = emergency_info.advice;
                emergencyAlert.style.display = 'flex';
            } else {
                emergencyAlert.style.display = 'none';
            }
            
            // æ›´æ–°è¯¦ç»†æŠ¥å‘Š
            updateDetailedReport(emotion_analysis, health_advice);
        }
        
        // æ›´æ–°å»ºè®®åˆ—è¡¨
        function updateAdviceList(elementId, items, append = false) {
            const listElement = document.getElementById(elementId);
            
            if (!append) {
                listElement.innerHTML = '';
            }
            
            if (items && items.length > 0) {
                items.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = item;
                    listElement.appendChild(li);
                });
            } else {
                const li = document.createElement('li');
                li.textContent = 'æš‚æ— å»ºè®®';
                listElement.appendChild(li);
            }
        }
        
        // æ›´æ–°è¯¦ç»†æŠ¥å‘Š
        function updateDetailedReport(emotionAnalysis, healthAdvice) {
            // æƒ…ç»ªæ¨¡å¼åˆ†æ
            document.getElementById('complexityValue').textContent = emotionAnalysis.emotion_complexity.toFixed(3);
            document.getElementById('intensityValue').textContent = emotionAnalysis.intensity_level;
            document.getElementById('mixedEmotions').textContent = emotionAnalysis.has_mixed_emotions ? 'æ˜¯' : 'å¦';
            
            // æ¬¡è¦æƒ…ç»ª
            const secondaryEmotionsDiv = document.getElementById('secondaryEmotions');
            secondaryEmotionsDiv.innerHTML = '';
            
            if (emotionAnalysis.secondary_emotions && emotionAnalysis.secondary_emotions.length > 0) {
                emotionAnalysis.secondary_emotions.forEach(sec => {
                    const div = document.createElement('div');
                    div.style.cssText = 'background: white; padding: 10px; margin-bottom: 10px; border-radius: 8px;';
                    div.innerHTML = `
                        <strong>${sec.emotion_zh} (${sec.emotion})</strong>: ${(sec.probability * 100).toFixed(1)}%
                        <div style="height: 10px; background: #ecf0f1; border-radius: 5px; margin-top: 5px;">
                            <div style="height: 100%; width: ${sec.probability * 100}%; 
                                      background-color: ${emotionColors[sec.emotion] || '#3498db'}; 
                                      border-radius: 5px;">
                            </div>
                        </div>
                    `;
                    secondaryEmotionsDiv.appendChild(div);
                });
            } else {
                secondaryEmotionsDiv.innerHTML = '<p style="color: #7f8c8d; text-align: center;">æ— æ˜æ˜¾çš„æ¬¡è¦æƒ…ç»ª</p>';
            }
            
            // ä¸“å®¶å»ºè®®
            const expertAdvice = document.getElementById('expertAdvice');
            let adviceText = `<strong>${emotionAnalysis.main_emotion_zh}æƒ…ç»ªç®¡ç†å»ºè®®:</strong><br>`;
            adviceText += `${healthAdvice.description}<br><br>`;
            
            if (emotionAnalysis.has_mixed_emotions) {
                adviceText += '<strong>ä¸“å®¶æç¤º:</strong> æ‚¨å¯èƒ½æ­£åœ¨ç»å†å¤æ‚çš„æ··åˆæƒ…ç»ªï¼Œå»ºè®®åˆ†åˆ«å¤„ç†æ¯ç§æƒ…ç»ªï¼Œå¹¶å¯»æ±‚ä¸“ä¸šæŒ‡å¯¼ã€‚';
            } else if (emotionAnalysis.intensity_level === 'éå¸¸é«˜') {
                adviceText += '<strong>ä¸“å®¶æç¤º:</strong> æƒ…ç»ªå¼ºåº¦è¾ƒé«˜ï¼Œå»ºè®®ä¼˜å…ˆé‡‡å–ç«‹å³è¡ŒåŠ¨å»ºè®®ï¼Œå¹¶åŠæ—¶å¯»æ±‚æ”¯æŒã€‚';
            } else {
                adviceText += '<strong>ä¸“å®¶æç¤º:</strong> å»ºè®®ç»“åˆç«‹å³è¡ŒåŠ¨å’Œé•¿æœŸå»ºè®®ï¼Œå»ºç«‹å¥åº·çš„æƒ…ç»ªç®¡ç†ä¹ æƒ¯ã€‚';
            }
            
            expertAdvice.innerHTML = adviceText;
        }
        
        // åˆ›å»ºæƒ…ç»ªå›¾è¡¨
        function createEmotionChart(probabilities) {
            const ctx = document.getElementById('emotionChart').getContext('2d');
            
            // å¦‚æœå·²æœ‰å›¾è¡¨ï¼Œé”€æ¯å®ƒ
            if (emotionChart) {
                emotionChart.destroy();
            }
            
            const labels = Object.keys(probabilities).map(emo => emotionChinese[emo] || emo);
            const data = Object.values(probabilities).map(p => p * 100);
            const backgroundColors = Object.keys(probabilities).map(emo => emotionColors[emo] || '#3498db');
            
            emotionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'æƒ…ç»ªæ¦‚ç‡ (%)',
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: backgroundColors.map(color => color.replace('0.8', '1')),
                        borderWidth: 1,
                        borderRadius: 5,
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'æ¦‚ç‡ (%)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'æƒ…ç»ªç±»å‹'
                            }
                        }
                    }
                }
            });
        }
        
        // æ‹–æ”¾åŠŸèƒ½
        const uploadArea = document.getElementById('uploadArea');
        
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.style.backgroundColor = '#e8f4fc';
            uploadArea.style.borderColor = '#2980b9';
        });
        
        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadArea.style.backgroundColor = '#f8f9fa';
            uploadArea.style.borderColor = '#3498db';
        });
        
        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.style.backgroundColor = '#f8f9fa';
            uploadArea.style.borderColor = '#3498db';
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.type.startsWith('image/')) {
                    // åˆ›å»ºFileListå¯¹è±¡
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    document.getElementById('fileInput').files = dataTransfer.files;
                    
                    // è§¦å‘æ–‡ä»¶é€‰æ‹©äº‹ä»¶
                    const event = new Event('change', { bubbles: true });
                    document.getElementById('fileInput').dispatchEvent(event);
                } else {
                    showStatus('è¯·é€‰æ‹©å›¾åƒæ–‡ä»¶', 'error');
                }
            }
        });
        
        // æ·»åŠ fetchè¶…æ—¶åŠŸèƒ½
        const originalFetch = window.fetch;
        window.fetch = function(resource, options = {}) {
            const timeout = options.timeout || 10000; // é»˜è®¤10ç§’è¶…æ—¶
            
            const controller = new AbortController();
            const signal = controller.signal;
            
            // è®¾ç½®è¶…æ—¶
            const timeoutId = setTimeout(() => {
                controller.abort();
            }, timeout);
            
            const fetchPromise = originalFetch(resource, {
                ...options,
                signal
            });
            
            // æ¸…ç†è¶…æ—¶
            fetchPromise.then(() => clearTimeout(timeoutId))
                       .catch(() => clearTimeout(timeoutId));
            
            return fetchPromise;
        };
    </script>
</body>
</html>